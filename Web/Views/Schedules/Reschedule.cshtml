@model MachineJobTask
@{
    ViewData["Title"] = "Reschedule Request";
}

<div class="container d-flex justify-content-center align-items-start min-vh-100 pt-2">
    <div class="card p-4 shadow-lg custom-box" style="width: 90%;">
        <h4 class="text-center mb-4">Rescheduling</h4>
        @if (!string.IsNullOrEmpty(ViewBag.Message))
        {
            <div class="alert alert-info text-center">
                @ViewBag.Message
            </div>
        }

        <div class="container mt-4">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#down"
                        type="button" role="tab">Machine Down</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#delay" type="button"
                        role="tab">Material Delay</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button"
                        role="tab">All Changes</button>
                </li>
            </ul>

            <div class="tab-content mt-3" id="myTabContent">

                <!-- Machine down -->
                <div class="tab-pane fade show active" id="down" role="tabpanel">
                    <form asp-action="Reschedule_down" asp-controller="Schedules" method="post">
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center">
                                <label for="machine" class="me-2 fw-bold"> Machine/Resource: </label>
                                <select class="form-select" id="machine" name="Machine">
                                    <option value="">Select a Machine</option>
                                    @foreach (var item in Model.Machines)
                                    {
                                        <option value="@item.Id">@item.Name</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Down date and time -->
                        <div class="row mb-3">
                            <label for="start_date" class="me-2 fw-bold">Down Start DateTime:</label>
                            <input type="datetime-local" class="form-control" id="start_date" name="Start_Date"
                                required>
                        </div>

                        <div class="row mb-3">
                            <label for="finish_date" class="me-2 fw-bold">Down Finish DateTime:</label>
                            <input type="datetime-local" class="form-control" id="finish_date" name="Finish_Date"
                                required>
                        </div>

                        <!-- Description -->
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center">
                                <label for="description" class="me-4 fw-bold" style="width: 100px">Description:</label>
                                <input type="text" class="form-control" id="description" name="description"
                                    placeholder="Optional Reason ...">
                            </div>
                        </div>

                        <!-- Add to Queue Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Add to Changes</button>
                        </div>
                    </form>
                </div>

                <!-- Material delay -->
                <div class="tab-pane fade show" id="delay" role="tabpanel">
                    <form asp-action="Reschedule_delay" asp-controller="Schedules" method="post">
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center">
                                <label for="job" class="me-2 fw-bold"> Job: </label>
                                <!-- Job dropdown -->
                                <select class="form-select" id="job" name="Job" required>
                                    @foreach (var item in Model.Jobs)
                                    {
                                        <option value="@item.JobNo">@item.JobNo - @item.Name</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center">
                                <label for="job" class="me-2 fw-bold"> Task: </label>
                                <!-- Task dropdown -->
                                <select class="form-select" id="task" name="Task" required>
                                    @foreach (var item in Model.Tasks)
                                    {
                                        <option value="@item.TaskSeq">@item.TaskSeq - @item.Description</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="materialReadyDatetime" class="me-2 fw-bold">Material Ready Datetime</label>
                            <input type="datetime-local" id="ready_datetime" name="ready_datetime" class="form-control"
                                required />
                        </div>

                        <!-- Description -->
                        <div class="row mb-3">
                            <div class="col-md-12 d-flex align-items-center">
                                <label for="description" class="me-4 fw-bold" style="width: 100px">Description:</label>
                                <input type="text" class="form-control" id="description" name="description"
                                    placeholder="Optional description...">
                            </div>
                        </div>

                        <!-- Add to Queue Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Add to Changes</button>
                        </div>
                    </form>
                </div>

                <!-- Queue and Final Submit -->
                <div class="tab-pane fade" id="queue" role="tabpanel">
                    <form asp-action="SubmitReschedulingChanges" asp-controller="Schedules" method="post">
                        <input type="hidden" id="selectedMachineDownIds" name="selectedMachineDownIds" value="" />
                        <input type="hidden" id="selectedMaterialDelayIds" name="selectedMaterialDelayIds" value="" />

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Machine Downs</h5>
                                @if (ViewBag.MachineDowns != null && ViewBag.MachineDowns.Count > 0)
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="selectAllMachineDowns" /></th>
                                                    <th>Machine</th>
                                                    <th>Start Time</th>
                                                    <th>End Time</th>
                                                    <th>Description</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < ViewBag.MachineDowns.Count; i++)
                                                {
                                                    var item = ViewBag.MachineDowns[i];
                                                    <tr>
                                                        <td><input type="checkbox" class="machine-down-check" data-index="@i"
                                                                checked /></td>
                                                        <td>@item.MachineName</td>
                                                        <td>@item.DownStartDateTime.ToString("yyyy-MM-dd HH:mm")</td>
                                                        <td>@item.DownEndDateTime.ToString("yyyy-MM-dd HH:mm")</td>
                                                        <td>@item.Description</td>
                                                        <td>
                                                            <form asp-action="RemoveMachineDown" asp-controller="Schedules"
                                                                method="post" style="display: inline;">
                                                                <input type="hidden" name="index" value="@i" />
                                                                <button type="submit"
                                                                    class="btn btn-sm btn-danger">Remove</button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <p>No machine downs in queue.</p>
                                }
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Material Delays</h5>
                                @if (ViewBag.MaterialDelays != null && ViewBag.MaterialDelays.Count > 0)
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="selectAllMaterialDelays" /></th>
                                                    <th>Job</th>
                                                    <th>Task</th>
                                                    <th>Ready Time</th>
                                                    <th>Description</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int i = 0; i < ViewBag.MaterialDelays.Count; i++)
                                                {
                                                    var item = ViewBag.MaterialDelays[i];
                                                    <tr>
                                                        <td><input type="checkbox" class="material-delay-check" data-index="@i"
                                                                checked /></td>
                                                        <td>@item.JobNo - @item.JobName</td>
                                                        <td>@item.TaskSeq - @item.TaskDescription</td>
                                                        <td>@item.MaterialReadyDateTime.ToString("yyyy-MM-dd HH:mm")</td>
                                                        <td>@item.Description</td>
                                                        <td>
                                                            <form asp-action="RemoveMaterialDelay" asp-controller="Schedules"
                                                                method="post" style="display: inline;">
                                                                <input type="hidden" name="index" value="@i" />
                                                                <button type="submit"
                                                                    class="btn btn-sm btn-danger">Remove</button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <p>No material delays in queue.</p>
                                }
                            </div>
                        </div>

                        <!-- Submit All Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="submitAll">Submit All Selected
                                Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Handle checkboxes
        document.addEventListener('DOMContentLoaded', function () {
            // Select all machine downs
            const selectAllMachineDowns = document.getElementById('selectAllMachineDowns');
            if (selectAllMachineDowns) {
                selectAllMachineDowns.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll('.machine-down-check');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            // Select all material delays
            const selectAllMaterialDelays = document.getElementById('selectAllMaterialDelays');
            if (selectAllMaterialDelays) {
                selectAllMaterialDelays.addEventListener('change', function () {
                    const checkboxes = document.querySelectorAll('.material-delay-check');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            // Submit form handling
            const form = document.querySelector('form[asp-action="SubmitReschedulingChanges"]');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault(); // Prevent default form submission

                    // Collect selected machine downs
                    const selectedMachineDowns = [];
                    document.querySelectorAll('.machine-down-check:checked').forEach(cb => {
                        selectedMachineDowns.push(cb.getAttribute('data-index'));
                    });
                    document.getElementById('selectedMachineDownIds').value = selectedMachineDowns.join(',');

                    // Collect selected material delays
                    const selectedMaterialDelays = [];
                    document.querySelectorAll('.material-delay-check:checked').forEach(cb => {
                        selectedMaterialDelays.push(cb.getAttribute('data-index'));
                    });
                    document.getElementById('selectedMaterialDelayIds').value = selectedMaterialDelays.join(',');

                    console.log("Selected machine downs:", selectedMachineDowns);
                    console.log("Selected material delays:", selectedMaterialDelays);

                    // If we have either selections or all checkboxes are selected (default behavior)
                    if (selectedMachineDowns.length > 0 || selectedMaterialDelays.length > 0 ||
                        (document.querySelectorAll('.machine-down-check').length === 0 &&
                            document.querySelectorAll('.material-delay-check').length === 0)) {
                        // Submit the form manually
                        form.submit();
                    } else {
                        alert('Please select at least one item to submit.');
                    }
                });
            }

            // Auto-show the queue tab if there are items or a message
            if (@(((ViewBag.MachineDowns?.Count ?? 0) > 0 || (ViewBag.MaterialDelays?.Count ?? 0) > 0) ? "true" : "false") ||
                '@ViewBag.Message' !== '') {
                // Check if we should auto-switch to the queue tab
                if (@(((ViewBag.MachineDowns?.Count ?? 0) > 0 || (ViewBag.MaterialDelays?.Count ?? 0) > 0) ? "true" : "false")) {
                    const queueTab = document.getElementById('queue-tab');
                    if (queueTab) {
                        queueTab.click();
                    }
                }
            }
        });
    </script>
}